generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String         @id @default(uuid())
  name                String
  email               String         @unique
  phone               String?
  passwordHash        String
  role                String         @default("AGENT")
  /// Assistant (manager) that this user belongs to. Used for team hierarchy.
  assistantId         String?
  assistant           User?          @relation("AssistantUsers", fields: [assistantId], references: [id])
  teamMembers         User[]         @relation("AssistantUsers")
  lastLogin           DateTime?
  active              Boolean        @default(true)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  uploadedAttachments Attachment[]
  auditLogs           AuditLog[]
  createdBanks        Bank[]
  createdClients      Client[]
  comments            Comment[]
  createdFormulas     Formula[]
  uploadedInventory   Inventory[]
  requestEvents       RequestEvent[]
  assignedRequests    Request[]      @relation("AssignedRequests")
  createdRequests     Request[]      @relation("CreatedRequests")
  uploadedSystemFiles SystemFile[]   @relation("UploadedSystemFiles")

  @@map("users")
}

model Client {
  id             String       @id @default(uuid())
  name           String
  nationalId     String?
  phonePrimary   String
  phoneSecondary String?
  email          String?
  city           String?
  address        String?
  source         String?
  notes          String?
  additionalData String?     // JSON string for storing additional client data
  commitments    String?      // JSON string for storing client commitments
  createdById    String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  attachments    Attachment[]
  createdBy      User         @relation(fields: [createdById], references: [id])
  comments       Comment[]
  requests       Request[]

  @@map("clients")
}

model Request {
  id                 String              @id @default(uuid())
  clientId           String
  title              String
  type               String              @default("UNKNOWN")
  requestType        String              @default("CASH")
  initialStatus      String              @default("NOT_ANSWERED")
  currentStatus      String              @default("NOT_ANSWERED")
  assignedToId       String?
  price              Decimal?
  customFields       String?
  isArchived         Boolean             @default(false)
  createdById        String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  attachments        Attachment[]
  comments           Comment[]
  installmentDetails InstallmentDetails?
  events             RequestEvent[]
  assignedTo         User?               @relation("AssignedRequests", fields: [assignedToId], references: [id])
  client             Client              @relation(fields: [clientId], references: [id])
  createdBy          User                @relation("CreatedRequests", fields: [createdById], references: [id])

  @@map("requests")
}

model InstallmentDetails {
  id                     String   @id @default(uuid())
  requestId              String   @unique
  carName                String?
  carPrice               Decimal?
  additionalFees         Decimal?
  shipping               Decimal?
  registration           Decimal?
  otherAdditions         Decimal?
  plateNumber            Decimal?
  age                    Int?
  salaryBankId           String?
  installmentBankId      String?
  salary                 Decimal?
  workOrganization       String?
  obligationTypes        String?
  deductionPercentage    Float?
  obligation1            Decimal?
  obligation2            Decimal?
  obligation3            Decimal?
  visaAmount             Decimal?
  deductedAmount         Decimal?
  finalAmount            Decimal?
  insurancePercentage    Float?
  hasServiceStop         Boolean  @default(false)
  financingBankId        String?
  downPaymentPercentage  Float?
  finalPaymentPercentage Float?
  profitMargin           Float?
  installmentMonths      Int?
  employerType           String?
  city                   String?
  isTransferredToBank    Boolean  @default(false)
  visaTotalAmount        Decimal?
  obligations            String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  financingBank          Bank?    @relation("FinancingBank", fields: [financingBankId], references: [id])
  installmentBank        Bank?    @relation("InstallmentBank", fields: [installmentBankId], references: [id])
  request                Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  salaryBank             Bank?    @relation("SalaryBank", fields: [salaryBankId], references: [id])

  @@map("installment_details")
}

model RequestEvent {
  id          String   @id @default(uuid())
  requestId   String
  fromStatus  String?
  toStatus    String
  comment     String?
  changedById String
  createdAt   DateTime @default(now())
  changedBy   User     @relation(fields: [changedById], references: [id])
  request     Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@map("request_events")
}

model Attachment {
  id           String   @id @default(uuid())
  requestId    String?
  clientId     String?
  filename     String
  storagePath  String
  mimeType     String
  uploadedById String
  uploadedAt   DateTime @default(now())
  client       Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  request      Request? @relation(fields: [requestId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])

  @@map("attachments")
}

model Comment {
  id        String   @id @default(uuid())
  requestId String?
  clientId  String?
  userId    String
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  client    Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  request   Request? @relation(fields: [requestId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@map("comments")
}

model Bank {
  id                     String               @id @default(uuid())
  name                   String               @unique
  code                   String?              @unique
  notes                  String?
  createdById            String
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  bankRates              BankRate[]
  createdBy              User                 @relation(fields: [createdById], references: [id])
  financingBankDetails   InstallmentDetails[] @relation("FinancingBank")
  installmentBankDetails InstallmentDetails[] @relation("InstallmentBank")
  salaryBankDetails      InstallmentDetails[] @relation("SalaryBank")

  @@map("banks")
}

model BankRate {
  id           String   @id @default(uuid())
  bankId       String
  employerType String
  clientType   String
  rate         Float
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  bank         Bank     @relation(fields: [bankId], references: [id], onDelete: Cascade)

  @@unique([bankId, employerType, clientType])
  @@map("bank_rates")
}

model Formula {
  id          String   @id @default(uuid())
  name        String   @unique
  expression  String
  description String?
  active      Boolean  @default(true)
  ownerId     String
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  owner       User     @relation(fields: [ownerId], references: [id])

  @@map("formulas")
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String
  actionType String
  targetType String
  targetId   String?
  details    String?
  createdAt  DateTime @default(now())
  actor      User     @relation(fields: [actorId], references: [id])

  @@map("audit_logs")
}

model Inventory {
  id           String   @id @default(uuid())
  headers      String
  data         String
  uploadedById String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])

  @@map("inventory")
}

model SystemFile {
  id           String   @id @default(uuid())
  name         String
  filename     String
  fileType     String
  storagePath  String?
  mimeType     String?
  uploadedById String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  uploadedBy   User     @relation("UploadedSystemFiles", fields: [uploadedById], references: [id])

  @@map("system_files")
}
